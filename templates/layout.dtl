<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
   <meta charset="utf-8" />
   <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
   <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
   <!-- Mobile viewport optimized: h5bp.com/viewport -->
   <meta name="viewport" content="width=device-width">

   <title>{{title|escape}}</title>

  
   <meta name="description" content="{{ description|escape }}" />
   <meta name="keywords" content="{{ keywords|join: ","}}" />
   <meta name="author" content="{{ author }}"/>
   
   <!-- remove or comment this line if you want to use the local fonts -->
   <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>

   <!--<link rel="stylesheet" type="text/css" href="content/css/bootstrap.css">-->
   <link rel="stylesheet" type="text/css" href="/static/content/css/bootmetro-icons.css">
   <link rel="stylesheet" type="text/css" href="/static/content/css/bootmetro.css">
   <link rel="stylesheet" type="text/css" href="/static/content/css/bootmetro-responsive.css">
   <link rel="stylesheet" type="text/css" href="/static/content/css/bootmetro-ui-light.css">
   <link rel="stylesheet" type="text/css" href="/static/content/css/datepicker.css">
   <!--[if IE 7]>
   <link rel="stylesheet" type="text/css" href="content/css/bootmetro-icons-ie7.css">
   <![endif]-->

   <!-- Le fav and touch icons -->
   <link rel="shortcut icon" href="/static/content/ico/favicon.ico">
   <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/static/content/ico/apple-touch-icon-144-precomposed.png">
   <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/static/content/ico/apple-touch-icon-114-precomposed.png">
   <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/static/content/ico/apple-touch-icon-72-precomposed.png">
   <link rel="apple-touch-icon-precomposed" href="/static/content/ico/apple-touch-icon-57-precomposed.png">
  
   <!-- All JavaScript at the bottom, except for Modernizr and Respond.
      Modernizr enables HTML5 elements & feature detects; Respond is a polyfill for min/max-width CSS3 Media Queries
      For optimal performance, use a custom Modernizr build: www.modernizr.com/download/ -->
   <script src="/static/scripts/modernizr-2.6.2.min.js"></script>
<!--
   <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', '{{google_analytics}}']);
      _gaq.push(['_trackPageview']);
      (function() {
         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
   </script>
   -->
</head>

<body>
   <!--[if lt IE 7]>
   <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
   <![endif]-->  

   <div class="navbar">
<div class="navbar-inner">
<a class="brand" >ErOnIDE</a>
{% include "partials/menu.dtl" %}
</div>
</div>
   {% comment %}   
   {% include "pages/index.dtl" %}
   {% include "partials/header-menu.dtl" %}
   {% include "partials/charms.dtl" %}
   {% endcomment %}
   
   <div class="container" >
   {% comment %}   
<div class="row">
<div class="span12">
	{% include "partials/breadcrumbs.dtl" %}
	
</div>
</div>
   {% endcomment %}
<div class="row">
<div id="project_tree" class="span3" style="height:330px; overflow:none">

</div>
<div class="span9" style="height:330px; overflow:none">

<div class="tabbable" style="position:relative; width:100%; height:330px;" id="filesbox"> <!-- Only required for left/right tabs -->
<ul class="nav nav-tabs">
<!--
<li class="active"><a href="#tab1" data-toggle="tab">Section 1</a></li>
<li><a href="#tab2" data-toggle="tab">Section 2</a></li>
-->
</ul>
<div class="tab-content">
<!--
<div class="tab-pane active" id="tab1">
<p>I'm in Section 1.</p>
</div>
<div class="tab-pane" id="tab2">
<p>Howdy, I'm in Section 2.</p>
</div>
-->
</div>
</div>


</div>
</div>
<div class="row">
<div class="span12">
	
<div class="navbar-fixed-bottom">
<div class="navbar-inner"> <div class="well well-small" id="thewell">Saved | Working...</div></div>
</div>
 
 
</div>
</div>
</div>

   <!-- Grab Google CDN's jQuery. fall back to local if necessary -->
   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
   <script>window.jQuery || document.write("<script src='/static/scripts/jquery-1.8.3.min.js'>\x3C/script>")</script>
   <script type="text/javascript" src="/static/scripts/jquery-ui.custom.min.js"></script>

   <script type="text/javascript" src="/static/scripts/google-code-prettify/prettify.js"></script>
   <script type="text/javascript" src="/static/scripts/bootstrap.min.js"></script>
   <script type="text/javascript" src="/static/scripts/bootmetro-panorama.js"></script>
   <script type="text/javascript" src="/static/scripts/bootmetro-pivot.js"></script>
   <script type="text/javascript" src="/static/scripts/bootmetro-charms.js"></script>
   <script type="text/javascript" src="/static/scripts/bootstrap-datepicker.js"></script>
   <!--<script type="text/javascript" src="/static/scripts/jquery.nicescroll.js"></script>-->
   <script type="text/javascript" src="/static/scripts/jquery.touchSwipe.js"></script>
   <script type="text/javascript" src="/static/scripts/jquery.json-2.4.min.js"></script>
	<script type="text/javascript" src="/static/scripts/jquery.cookie.js"></script>
	<script type="text/javascript" src="/static/scripts/jquery.hotkeys.js"></script>
<!--	<script type="text/javascript" src="/static/scripts/jstree/jquery.jstree.js"></script> -->

<!-- Include the basic stylesheet: -->
  <link href="/static/content/dynatree/ui.dynatree.css" rel="stylesheet" type="text/css">
  <script src="/static/scripts/jquery.dynatree.min.js" type="text/javascript"></script>
  <script src="/static/scripts/jq.context/jquery.ui.position.js" type="text/javascript"></script>
  <script src="/static/scripts/jq.context/jquery.contextMenu.js" type="text/javascript"></script>
  <link href="/static/scripts/jq.context/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
  
 {% include "partials/codemirror.dtl" %}
{% include "partials/login.dtl" %}
{% include "partials/saveas.dtl" %}
{% include "partials/rename.dtl" %}
{% include "partials/newproject.dtl" %}
{% include "partials/quickstart.dtl" %}
{% include "partials/websocket.dtl" %}
<script type="text/javascript">
	
	function basename(str)
	{
	   var base = new String(str).substring(str.lastIndexOf('/') + 1); 
	   return base;
	}
	
	function safeSelector(name)
	{
		return name.replace(/([\/\!\"\#\$\%\&\'\(\)\*\+\,\.\:\;\<\=\>\?\@\[\\\]\^\`\{\|\}\~])/gi,'\\$1')
	}
	
	
	function tabAdd(sel, filepath, content, show){
		var tabs = $(sel);	
		var label=basename(filepath);
		var safesel=safeSelector(filepath)
		$('div.active', tabs).removeClass('in').add($('li.active', tabs)).removeClass('active');
		$('.tab-content', tabs).append('<div class="tab-pane in active" style="position:relative; width:100%; height:100%; overflow:hidden" id="pane:'+eronide.windows+'">'+content+'</div>');
		$('.nav-tabs', tabs).append('<li><a href="#'+safeSelector('pane:'+eronide.windows)+'" data-toggle="tab" id="tab:'+eronide.windows+'">'+label+'</a></li>');

//		jQuery.data($('#tab-'+id), "filepath");
		$('a[data-toggle="tab"]').on('shown', function (e) {
			var fp=$(e.target)[0].id;
			var window=fp.slice(fp.indexOf(':')+1);
			var filename=undefined
			var found=undefined
			for(var i = 0; i < eronide.files.length; i++)
			{
				if (window==eronide.files[i].window)
				{
					filename=eronide.files[i].file
					found=eronide.files[i]
					break;
				}
			}
			
//			setBreadcrumbsFromPath(filename);
			eronide.currentfile=filename;
			var state=(found!=undefined && found.newfile==false);
			$("#states_save_as").attr("disabled", "");
			$("#states_save_as").removeClass("disabled");
			$("#menu_edit_undo").attr("disabled", "");
			$("#menu_edit_undo").removeClass("disabled");
			$("#menu_edit_redo").attr("disabled", "");
			$("#menu_edit_redo").removeClass("disabled");
			$("#menu_file_close").attr("disabled", "");
			$("#menu_file_close").removeClass("disabled");
			$("#states_close").attr("disabled", "");
			$("#states_close").removeClass("disabled");
			if (state)
			{
				$("#states_save").attr("disabled", "");
				$("#states_save").removeClass("disabled");
			} else
			{
				$("#states_save").attr("disabled",  "disabled");
				$("#states_save").addClass("disabled");
			}
		})
		if(show==true) 
		{
			$('#'+safeSelector('tab:'+eronide.windows)).tab('show');
			eronide.currentfile=filepath
			$("#states_save").attr("disabled", "");
			$("#states_save").removeClass("disabled");
			$("#states_save_as").attr("disabled", "");
			$("#states_save_as").removeClass("disabled");
			$("#menu_edit_undo").attr("disabled", "");
			$("#menu_edit_undo").removeClass("disabled");
			$("#menu_edit_redo").attr("disabled", "");
			$("#menu_edit_redo").removeClass("disabled");
		}
//		setBreadcrumbsFromPath(filepath)
		return ($())
	}
$(document).ready(function(){
	
	
	
	
	$("#project_tree").dynatree({
		fx: { height: "toggle", duration: 200 },
		autoCollapse: false,
		onDblClick: function(node, event) {
			if (!node.data.isFolder) loadFile(node.data.key);
		  return false;
		},
		dnd: {
			autoExpandMS: 250,
			preventVoidMoves: true, 
			onKeydown: function(node, event) {
				// Eat keyboard events, when a menu is open
				if( $(".contextMenu:visible").length > 0 ){
				  return false;
				}
			},
			onDragStart: function(node) {
			/** This function MUST be defined to enable dragging for the tree.
			 *  Return false to cancel dragging of node.
			 */
				return true;
			},
			onDragEnter: function(node, sourceNode) {
			/** sourceNode may be null for non-dynatree droppables.
			 *  Return false to disallow dropping on node. In this case
			 *  onDragOver and onDragLeave are not called.
			 *  Return 'over', 'before, or 'after' to force a hitMode.
			 *  Return ['before', 'after'] to restrict available hitModes.
			 *  Any other return value will calc the hitMode from the cursor position.
			 */
			// Prevent dropping a parent below another parent (only sort
			// nodes under the same parent)
//			if(node.parent !== sourceNode.parent){
//				return false;
//			}
			// Don't allow dropping *over* a node (would create a child)
				return node.data.isFolder ? ["over", "before", "after"] : ["before", "after"] ;
			},
			onDrop: function(node, sourceNode, hitMode, ui, draggable) {
			/** This function MUST be defined to enable dropping of items on
			 *  the tree.
			 */
				sourceNode.move(node, hitMode);
				var path=node.data.isFolder ?  node.data.key : node.data.key.substring(0,node.data.key.lastIndexOf("/"));
				var basename=sourceNode.data.key.substring(sourceNode.data.key.lastIndexOf("/")+1);
				var newname=path+"/"+basename
				moveFile(sourceNode.data.key, newname)
				sourceNode.data.key=newname
			}
		}
    });
    
    $(document).on('mousedown.contextMenu', function(e){
		var node = $.ui.dynatree.getNode(e.target);
//		window.console && console.log("e: %o, node: %o", e, node);
		node && node.activate();
	});
	
	$.contextMenu({
	  // bind menu to every dynatree node
	  selector: 'a.dynatree-title',
	  // called for every menu command
	  callback: function(cmd, options) {
		  var node = $.ui.dynatree.getNode(this);
		  var path=node.data.isFolder ?  node.data.key : node.getParent().data.key//.substring(0,node.data.key.lastIndexOf("/"));
		  switch(cmd)
		  {
			  case "cut":
				eronide.action="cut";
				eronide.sourceNode=node;
			  break;
			  case "copy":
				eronide.action="copy";
				eronide.sourceNode=node;
			  break;
			  case "paste":
				var basename=eronide.sourceNode.data.key.substring(eronide.sourceNode.data.key.lastIndexOf("/")+1);
				var newname=path+"/"+basename
				var targetNode=node.data.isFolder ? node : node.getParent();
				switch (eronide.action)
				{
					case "cut":
						moveFile(eronide.sourceNode.data.key, newname)
						eronide.sourceNode.data.key=newname
						var isRecursive = false;
						var cb = eronide.sourceNode.toDict(true, function(dict){
							// If one of the source nodes is the target, we must not move
							if( dict.key == targetNode.data.key )
								isRecursive = true;
						});
						if( isRecursive ) {
							return;
						}
						cb.key=newname;
						targetNode.addChild(cb);
						eronide.sourceNode.remove();					
						eronide.action=undefined
					break;
					case "copy":
						var isRecursive = false;
						
						var cb = eronide.sourceNode.toDict(true, function(dict){
							// If one of the source nodes is the target, we must not move
							if( dict.key == targetNode.data.key )
								isRecursive = true;
						});
						if( isRecursive ) {
							return;
						}
						if (eronide.sourceNode.getParent()==targetNode)
						{
							cb.title="Copy "+(eronide.sourceNode.data.copies==undefined ? eronide.sourceNode.data.copies=1 : ++eronide.sourceNode.data.copies)+" of "+basename;
							cb.key=targetNode.data.key+"/"+cb.title;
						} else 
						{
							cb.key=newname
						}
						copyFile(eronide.sourceNode.data.key, cb.key)
						targetNode.addChild(cb);
//						eronide.action=undefined
					break;
				
				}
			  break;
			  case "rename":
				if (node.getParent().data.title!="./")
				{
					eronide.sourceNode=node
					$("#rename_oldfilename").val(node.data.title);
					$("#inputRename").val(node.data.title);
					$('#dialog_rename').modal('show');
				}
			  break;
			  case "edit":
				if (!node.data.isFolder) loadFile(node.data.key);
			  break;
			  case "delete":
				if (confirm("Are you sure to delete '"+node.data.key+" ?"))
				{
					deleteFile(node.data.key)
					node.remove();
				}
			  break;
		  }
/*		
var s='';
for (var i in node.data) s+=i+' : '+node.data[i]+'\n';
alert(cmd+'\n'+node.data.key);
*/
		node.activate();
//		copyPaste(cmd, node);
	  },
	  items: {
		"rename": {name: "Rename"},
		"edit": {name: "Edit"},
		"cut": {name: "Cut"},
		"copy": {name: "Copy"},
		"paste": {name: "Paste"},
		"delete": {name: "Delete"},
		"sep1": "---------",
		"newdir": {name: "New directory" },
		"new": {name: "New file" },
		"newfrom": {name: "New file from..." ,
			items: {
{% for filegroup in filetypes %}
{% if not forloop.first %}
	,
	{% endif %}
				"disabled_new_{{filegroup.name}}": { name:"{{filegroup.name}}",  disabled: true}
	{% for filetype in filegroup.items %}
				,"new_from_{{filetype.type}}": {name: "&nbsp;{{filetype.name}}" }
	{% endfor %}
{% endfor %}
			}
		}
	  }
	});
    
    $('#menu_file_save').click(function(e){
		e.preventDefault();
		saveCurrentFile();
	}); 
	
    $('#menu_file_reload').click(function(e){
		e.preventDefault();
		reloadFile();
	}); 
	
	$('#menu_file_new').click(function(e){
		e.preventDefault();
		newFile();
	}); 
	
	$('#menu_file_close').click(function(e){
		e.preventDefault();
		closeFile();
	});
	
	$('#menu_file_save_as').click(function(e){
		e.preventDefault();
		saveFileAs();
	}); 
	
	$('#menu_edit_undo').click(function(e){
		e.preventDefault();
		var found=searchCurrent(eronide.currentfile);
		if (found!=undefined) found.editor.undo();
	}); 

	$('#menu_edit_redo').click(function(e){
		e.preventDefault();
		var found=searchCurrent(eronide.currentfile);
		if (found!=undefined) found.editor.redo();
	}); 
	
	$('#menu_project_upload').click(function(e){
		e.preventDefault();
		
	}); 

	{% for ptemplate in ptemplates %}
		{% if ptemplate.key %}
	$('#menu_project_new_{{ptemplate.key}}').click(function(e){
		e.preventDefault();
		createProject("{{ptemplate.name}}");
	});
		{% endif %}
	{% endfor %}
});


</script>


</body>
</html>
